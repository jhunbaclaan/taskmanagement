<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard ‚Äî Task Manager</title>
  <style>
    :root {
      --bg: #fafafa;
      --card-bg: #ffffff;
      --text-primary: #002856;
      --text-secondary: #4f758b;
      --border: #e3e5e8;
      --accent: #3b82f6;
      --base-font-size: 18px;
    }

    * {
      box-sizing: border-box;
    }

    html {
      font-size: var(--base-font-size);
    }

    body {
      font-family: "Tahoma", "Verdana", sans-serif;
      background-color: var(--bg);
      color: var(--text-primary);
      margin: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      transition: font-size 0.2s ease;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.5rem 2.5rem;
      border-bottom: 1px solid var(--border);
      background-color: #71B1C8;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    header h1 {
      color: white;
      font-size: 1.8rem;
      font-weight: 600;
      margin: 0;
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .add-btn {
      background-color: #007298;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 0.7rem 1.2rem;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .add-btn:hover {
      background-color: #005a7a;
    }

    .font-slider {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: white;
      font-size: 0.9rem;
    }

    .font-slider input[type="range"] {
      width: 120px;
      cursor: pointer;
      accent-color: #4f758b;
    }

    main {
      flex: 1;
      padding: 2rem 3rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    /* Filter + Search Section */
    .filter-bar {
      background-color: var(--card-bg);
      border: 4px solid var(--border);
      border-radius: 10px;
      padding: 1rem 1.5rem;
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
      justify-content: space-between;
    }

    .filter-group {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }

    select,
    input[type="search"] {
      padding: 0.6rem 1rem;
      border: 3px solid var(--border);
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.2s ease;
    }

    select:focus,
    input:focus {
      outline: none;
      border-color: #4f758b;
    }

    /* Task List */
    #taskList {
      background-color: var(--card-bg);
      border: 4px solid var(--border);
      border-radius: 10px;
      padding: 1.5rem 2rem;
    }

    .task-item {
      border-bottom: 2px solid var(--border);
      padding: 1rem 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .task-item:last-child {
      border-bottom: none;
    }

    .task-info {
      flex: 1;
      min-width: 250px;
    }

    .task-title {
      font-weight: 600;
      font-size: 1.1rem;
      color: var(--text-primary);
    }

    .task-meta {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .task-actions {
      display: flex;
      gap: 0.5rem;
    }

    .task-item.completed {
      background-color: #0b9c0b96;
    }

    .task-item.completed .task-title {
      text-decoration: line-through;
      color: rgb(255, 255, 255);
    }

    .delete-btn,
    .edit-btn,
    .complete-btn {
      border: none;
      border-radius: 8px;
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .complete-btn {
      background-color: #049604;
      color: white;
    }

    .complete-btn:hover {
      background-color: #4cae4c;
    }

    .delete-btn {
      background-color: #d9534f;
      color: white;
    }

    .delete-btn:hover {
      background-color: #b52b27;
    }

    .edit-btn {
      background-color: #f0ad4e;
      color: white;
    }

    .edit-btn:hover {
      background-color: #d98c23;
    }

    .footer-note {
      text-align: center;
      color: var(--text-secondary);
      font-size: 0.85rem;
      margin: 1rem 0 2rem;
    }
  </style>
</head>

<body>
  <header>
    <h1>Task Dashboard</h1>
    <div class="header-controls">
      <div class="font-slider">
        <label for="fontSizeSlider" style="color:white;">Text Size:</label>
        <input type="range" id="fontSizeSlider" min="12" max="22" value="16" />
      </div>
      <a href="{% url 'create' %}" class="add-btn">Ôºã Add Task</a>
    </div>
  </header>

  <main>
    <!-- Filter and Search -->
    <div class="filter-bar">
      <div class="filter-group">
        <label>Filter:</label>
        <select id="filterCategory">
          <option value="all">All Categories</option>
          <option value="Work">Work</option>
          <option value="Personal">Personal</option>
          <option value="Social">Social</option>
          <option value="Financial">Financial</option>
          <option value="School">School</option>
          <option value="Health">Health</option>
        </select>

        <select id="filterPriority">
          <option value="all">All Priorities</option>
          <option value="One">One (High)</option>
          <option value="Two">Two</option>
          <option value="Three">Three</option>
          <option value="Four">Four</option>
          <option value="Five">Five (Low)</option>
        </select>

        <select id="filterDeadline">
          <option value="default">All Deadlines</option>
          <option value="upcoming">Upcoming (Soonest First)</option>
          <option value="past">Past Due</option>
        </select>

        <!-- ‚úÖ Sorting -->
        <select id="sortBy">
          <option value="none">Sort By (Default)</option>
          <option value="deadlineAsc">Deadline ‚Üë</option>
          <option value="deadlineDesc">Deadline ‚Üì</option>
          <option value="priorityAsc">Priority ‚Üë</option>
          <option value="priorityDesc">Priority ‚Üì</option>
        </select>
      </div>

      <div class="filter-group">
        <input type="search" id="searchInput" placeholder="üîç Search tasks..." />
      </div>
    </div>

    <!-- Task List -->
    <div id="tasks">
      <h2 style="margin-bottom: 1rem;">My Tasks</h2>
      <div id="taskContainer">
        <ul id="taskList">
          {% for task in tasks %}
          <li class="task-item" data-category="{{ task.category}}" data-priority="{{ task.priority }}"
            data-deadline="{{ task.deadline }}">
            <div class="task-info">
              <div class="task-title">{{ task.title }}</div>
              <div class="task-meta">
                üìÖ {{ task.deadline|date:"M d, Y" }} |
                üè∑Ô∏è {{ task.category }} |
                ‚ö° Priority: {{ task.priority }}
              </div>
              <div class="task-meta">{{ task.description }}</div>
              <div class="task-meta">{{ task.notes }}</div>
            </div>
            <div class="task-actions">
              <button class="edit-btn" data-id="{{ task.id }}">Edit</button>
              <button class="delete-btn" data-id="{{ task.id }}">Delete</button>
              <button class="complete-btn" data-id="{{ task.id }}">Complete</button>
            </div>
          </li>
          {% empty %}
          <li>No tasks yet.</li>
          {% endfor %}
        </ul>

      </div>
    </div>
  </main>

  <p class="footer-note">Filter, search, or sort your tasks with ease.</p>

  <script>
    // Font size slider (keep this)
    const fontSlider = document.getElementById("fontSizeSlider");
    fontSlider.addEventListener("input", function () {
      document.documentElement.style.setProperty("--base-font-size", this.value + "px");
    });

    const priorityMap = {
      "one": 1, "1": 1,
      "two": 2, "2": 2,
      "three": 3, "3": 3,
      "four": 4, "4": 4,
      "five": 5, "5": 5
    };

    function priorityToNumber(raw) {
      if (raw === undefined || raw === null) return 999;
      const key = String(raw).trim().toLowerCase();
      // return mapped number if known, otherwise try numeric parse, otherwise large number
      if (priorityMap.hasOwnProperty(key)) return priorityMap[key];
      const n = Number(key);
      return Number.isFinite(n) ? n : 999;
    }

    // grab controls + container
    const searchInput = document.getElementById("searchInput");
    const filterCategory = document.getElementById("filterCategory");
    const filterPriority = document.getElementById("filterPriority");
    const filterDeadline = document.getElementById("filterDeadline");
    const sortBy = document.getElementById("sortBy");
    const taskList = document.getElementById("taskList");

    function getTaskItems() {
      return Array.from(taskList.querySelectorAll(".task-item"));
    }

    function filterAndSortTasks() {
      const searchText = (searchInput?.value || "").toLowerCase();
      const category = filterCategory?.value || "all";
      const priorityFilter = filterPriority?.value || "all";
      const deadlineFilter = filterDeadline?.value || "default";
      const sortValue = sortBy?.value || "none";
      const now = new Date();

      const tasks = getTaskItems();

      // --- FILTERING ---
      tasks.forEach(task => {
        const titleEl = task.querySelector(".task-title");
        const metas = task.querySelectorAll(".task-meta");
        const title = titleEl ? titleEl.textContent.toLowerCase() : "";
        const desc = metas && metas.length >= 2 ? metas[1].textContent.toLowerCase() : (metas[0]?.textContent || "").toLowerCase();
        const taskCategory = task.dataset.category || "";
        const taskPriorityRaw = task.dataset.priority;
        const taskPriorityNum = priorityToNumber(taskPriorityRaw);
        const taskDeadline = task.dataset.deadline ? new Date(task.dataset.deadline) : new Date(0);

        let visible = true;

        // search
        if (searchText && !(title.includes(searchText) || desc.includes(searchText))) visible = false;

        // category filter
        if (category !== "all" && taskCategory !== category) visible = false;

        // priority filter
        if (priorityFilter !== "all") {
          const filterNum = priorityToNumber(priorityFilter);
          if (filterNum !== taskPriorityNum) visible = false;
        }

        // deadline filter
        if (deadlineFilter === "upcoming" && taskDeadline < now) visible = false;
        else if (deadlineFilter === "past" && taskDeadline >= now) visible = false;

        task.style.display = visible ? "flex" : "none";
      });

      // --- SORTING ---
      // Only sort visible tasks so hidden tasks keep their place
      const visibleTasks = tasks.filter(t => t.style.display !== "none");

      visibleTasks.sort((a, b) => {
        // compute numeric priority values (lower = higher priority if you're using 1=High)
        const pA = priorityToNumber(a.dataset.priority);
        const pB = priorityToNumber(b.dataset.priority);

        // compute deadlines (ms)
        const dA = a.dataset.deadline ? new Date(a.dataset.deadline).getTime() : 0;
        const dB = b.dataset.deadline ? new Date(b.dataset.deadline).getTime() : 0;

        // Primary comparison depends on selected sort
        switch (sortValue) {
          case "priorityAsc":
            // numeric ascending: 1,2,3,4,5
            return (pA - pB) || (dA - dB); // tie-breaker: earlier deadline first
          case "priorityDesc":
            // numeric descending: 5,4,3,2,1
            return (pB - pA) || (dA - dB);
          case "deadlineAsc":
            return (dA - dB) || (pA - pB);
          case "deadlineDesc":
            return (dB - dA) || (pA - pB);
          default:
            return 0;
        }
      });

      // Re-append visible tasks in sorted order
      visibleTasks.forEach(t => taskList.appendChild(t));
    }

    // wire up events
    [searchInput, filterCategory, filterPriority, filterDeadline, sortBy].forEach(el => {
      if (!el) return;
      el.addEventListener("input", filterAndSortTasks);
      el.addEventListener("change", filterAndSortTasks);
    });

    // initialize
    document.addEventListener("DOMContentLoaded", filterAndSortTasks);

    // Complete button ‚Äî toggle UI and persist
    document.addEventListener("DOMContentLoaded", () => {

      function getCookie(name) {
        // simple CSRF cookie reader for Django
        const match = document.cookie.match(new RegExp('(^|; )' + name + '=([^;]+)'));
        return match ? decodeURIComponent(match[2]) : null;
      }
      const csrftoken = getCookie('csrftoken');

      document.querySelectorAll(".complete-btn").forEach(btn => {
        // initialize label/state from surrounding li[data-completed] if present
        const taskItem = btn.closest(".task-item");
        if (taskItem) {
          const dataCompleted = taskItem.dataset.completed;
          if (dataCompleted === "true" || dataCompleted === "True") {
            taskItem.classList.add("completed");
            btn.textContent = "Undo";
          } else {
            btn.textContent = "Complete";
          }
        }

        btn.addEventListener("click", async () => {
          const taskItem = btn.closest(".task-item");
          const taskId = btn.dataset.id;
          if (!taskItem || !taskId) return;

          // optimistic UI toggle
          const willComplete = !taskItem.classList.contains("completed");
          taskItem.classList.toggle("completed", willComplete);
          btn.textContent = willComplete ? "Undo" : "Complete";

          try {
            const res = await fetch(`/complete/${taskId}/`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken || ''
              },
              body: JSON.stringify({ completed: willComplete })
            });
            if (!res.ok) {
              // revert UI on failure
              taskItem.classList.toggle("completed", !willComplete);
              btn.textContent = !willComplete ? "Undo" : "Complete";
              const text = await res.text().catch(() => res.statusText);
              console.error('Failed to update task state:', res.status, text);
              alert('Failed to update task state (server error).');
            }
          } catch (err) {
            // network error -> revert UI
            taskItem.classList.toggle("completed", !willComplete);
            btn.textContent = !willComplete ? "Undo" : "Complete";
            console.error('Network error while updating task state', err);
            alert('Network error while updating task state.');
          }
        });
      });
    });

    // EDITING TASKS
    document.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll(".edit-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const taskItem = btn.closest(".task-item");
          const taskId = btn.dataset.id;

          // Collect data from the task element
          const title = taskItem.querySelector(".task-title").textContent.trim();
          const metas = taskItem.querySelectorAll(".task-meta");
          const description = metas.length > 1 ? metas[1].textContent.trim() : "";
          const deadline = taskItem.dataset.deadline;
          const category = taskItem.dataset.category;
          const priority = taskItem.dataset.priority;

          // Save in localStorage to use on create page
          const editTask = { id: taskId, title, description, deadline, category, priority };
          localStorage.setItem("editTask", JSON.stringify(editTask));

          // Redirect to create page
          window.location.href = "{% url 'create' %}";
        });
      });
    });
  </script>

</body>

</html>
